<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!-- <meta http-equiv="Content-Security-Policy" content="script-src 'self'; img-src 'self' app:;"> -->
    <link rel="stylesheet" href="overlay-styles.css">
</head>

<body class="image-overlay">
    <div class="overlay-box image-overlay-box">
        <div class="overlay-header">
            <div class="area-title" id="image-title">Map Layout</div>
            <div class="overlay-controls">
                <button class="overlay-btn" id="zoom-out" title="Zoom Out">-</button>
                <button class="overlay-btn" id="zoom-in" title="Zoom In">+</button>
                <button class="overlay-btn" id="reset-zoom" title="Reset Zoom">⟲</button>
                <button class="overlay-btn" id="drag-handle" title="Drag to move">↕</button>
                <button class="overlay-btn" id="settings-btn" title="Overlay Settings">⚙</button>
                <button class="overlay-btn" id="close-btn" title="Close">✕</button>
            </div>
        </div>

        <div class="image-container" id="image-container">
            <img id="main-image" src="assets/maps/default.jpg" alt="Map Layout">
        </div>

        <div class="overlay-settings" id="settings-panel" style="display: none;">
            <h3>Image Overlay Settings</h3>
            <div class="settings-row">
                <label>Opacity:</label>
                <input type="range" id="opacity-slider" min="0.1" max="1" step="0.1" value="0.9">
                <span id="opacity-value">0.9</span>
            </div>
            <div class="settings-row">
                <label>Width:</label>
                <input type="number" id="width-input" min="200" max="1000" value="500">
            </div>
            <div class="settings-row">
                <label>Height:</label>
                <input type="number" id="height-input" min="200" max="800" value="400">
            </div>
            <div class="settings-row buttons">
                <button id="apply-settings">Apply</button>
                <button id="close-settings">Close</button>
            </div>
        </div>
    </div>

    <script>
        let currentZoom = 1;
        let isDragging = false;
        let startX, startY, imgX = 0, imgY = 0;
        const mainImage = document.getElementById('main-image');
        const imageContainer = document.getElementById('image-container');

        // Handle image being set
        window.imageOverlayAPI.onSetImage((imagePath) => {
            mainImage.src = imagePath;
            resetZoom();
        });

        // Handle area changes
        window.imageOverlayAPI.onAreaChanged((area, info) => {
            document.getElementById('image-title').textContent = `${area} Layout`;
        });

        // Zoom controls
        document.getElementById('zoom-in').addEventListener('click', () => {
            currentZoom += 0.2;
            updateImageTransform();
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            currentZoom = Math.max(0.5, currentZoom - 0.2);
            updateImageTransform();
        });

        document.getElementById('reset-zoom').addEventListener('click', () => {
            resetZoom();
        });

        function resetZoom() {
            currentZoom = 1;
            imgX = 0;
            imgY = 0;
            updateImageTransform();
        }

        function updateImageTransform() {
            mainImage.style.transform = `translate(${imgX}px, ${imgY}px) scale(${currentZoom})`;
        }

        // Image dragging
        mainImage.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            mainImage.style.cursor = 'grabbing';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            imgX += dx;
            imgY += dy;
            startX = e.clientX;
            startY = e.clientY;

            updateImageTransform();
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            mainImage.style.cursor = 'grab';
        });

        // Drag overlay functionality
        document.getElementById('drag-handle').addEventListener('mousedown', (e) => {
            window.imageOverlayAPI.startDrag('image', { x: e.screenX, y: e.screenY });
        });

        // Close button
        document.getElementById('close-btn').addEventListener('click', () => {
            window.imageOverlayAPI.toggleOverlay('image');
        });

        // Settings panel toggle
        document.getElementById('settings-btn').addEventListener('click', () => {
            const panel = document.getElementById('settings-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        });

        // Settings controls
        document.getElementById('opacity-slider').addEventListener('input', function () {
            document.getElementById('opacity-value').textContent = this.value;
        });

        document.getElementById('apply-settings').addEventListener('click', () => {
            const opacity = parseFloat(document.getElementById('opacity-slider').value);
            const width = parseInt(document.getElementById('width-input').value);
            const height = parseInt(document.getElementById('height-input').value);

            window.imageOverlayAPI.updateSettings('image', { opacity, width, height });
            document.getElementById('settings-panel').style.display = 'none';
        });

        document.getElementById('close-settings').addEventListener('click', () => {
            document.getElementById('settings-panel').style.display = 'none';
        });

        // Request current area on load
        window.imageOverlayAPI.requestCurrentArea();
    </script>
</body>

</html>